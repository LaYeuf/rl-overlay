<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin - RL Overlay</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0b0b10;color:#f4f4ff}
  a{color:inherit}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:18px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .row>*{flex:1}
  label{font-size:12px;opacity:.85;display:block;margin:8px 0 6px}
  input,select,button,textarea{font:inherit}
  input,textarea{width:100%;box-sizing:border-box;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:12px;padding:10px 12px;outline:none}
  input:disabled,textarea:disabled{opacity:.6}
  button{background:linear-gradient(90deg,#5d7cff,#8a55ff);border:none;color:#fff;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer}
  button.secondary{background:rgba(255,255,255,.10)}
  button.danger{background:rgba(255,80,80,.20);border:1px solid rgba(255,80,80,.35)}
  .top{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
  .muted{opacity:.75}
  .events{margin-top:16px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  td{padding:12px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
  td:first-child{border-radius:14px 0 0 14px}
  td:last-child{border-radius:0 14px 14px 0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-size:12px}
  .ok{color:#78ff9a}
  .bad{color:#ff7a7a}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:22px;z-index:50;overflow:auto}
  .modal .box{width:min(980px,100%);background:#101020;border:1px solid rgba(255,255,255,.12);border-radius:18px;overflow:hidden;display:flex;flex-direction:column;max-height:calc(100vh - 44px)}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.10)}
  .modal main{padding:16px;overflow:auto;min-height:0}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .modal .actions{position:sticky;bottom:0;background:rgba(16,16,32,.92);padding:12px 0 4px;border-top:1px solid rgba(255,255,255,.10);backdrop-filter:blur(6px)}
  /* Layout editor */
  .editorWrap{display:grid;grid-template-columns:1fr 320px;gap:12px}
  @media (max-width:1000px){.editorWrap{grid-template-columns:1fr}}
  .preview{position:relative;width:100%;aspect-ratio:16/9;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.10);border-radius:16px;overflow:hidden}
  .preview img{position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none}
  .handle{position:absolute;border:2px dashed rgba(255,255,255,.65);border-radius:10px;background:rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:12px;cursor:move;user-select:none}
  .handle small{opacity:.9}
  .tiny{font-size:12px;opacity:.8}
  .kv{display:grid;grid-template-columns:100px 1fr;gap:8px;align-items:center;margin:8px 0}
  .kv input{padding:8px 10px;border-radius:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div style="font-size:22px;font-weight:900">Admin Overlay</div>
      <div class="muted">Cr√©e des events, configure le HUD (frame Photoshop), et partage un lien OBS.</div>
    </div>
    <div class="pill" id="authPill">üîí <span id="authTxt">Non connect√©</span></div>
  </div>

  <div class="card" style="margin-top:14px" id="loginCard">
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="admin@exemple.com"/>
      </div>
      <div>
        <label>Mot de passe</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
      </div>
      <div style="flex:0 0 200px;display:flex;align-items:flex-end">
        <button id="btnLogin" style="width:100%">Se connecter</button>
      </div>
    </div>
    <div class="tiny" id="loginMsg" style="margin-top:10px"></div>
  </div>

  <div class="events card" id="eventsCard" style="display:none">
    <div class="top">
      <div>
        <div style="font-weight:900;font-size:16px">√âv√©nements</div>
        <div class="muted">Chaque event = une URL overlay diff√©rente (multi-casts OK).</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="secondary" id="btnNew">+ Nouvel √©v√©nement</button>
        <button class="secondary" id="btnLogout">D√©connexion</button>
      </div>
    </div>

    <table id="eventsTable" style="margin-top:12px"></table>
  </div>
</div>

<!-- Modal: Create/Edit Event -->
<div class="modal" id="eventModal">
  <div class="box">
    <header>
      <div style="font-weight:900" id="modalTitle">Nouvel √©v√©nement</div>
      <button class="secondary" id="btnCloseModal">‚úï</button>
    </header>
    <main>
      <div class="grid2">
        <div>
          <label>Nom de l'√©v√©nement</label>
          <input id="f_event_name" placeholder="GAME 1 TEST"/>
        </div>
        <div>
          <label>Best Of</label>
          <input id="f_best_of" type="number" min="1" value="5"/>
        </div>

        <div>
          <label>√âquipe Bleue</label>
          <input id="f_blue_name" placeholder="TEAM BLUE"/>
        </div>
        <div>
          <label>√âquipe Orange</label>
          <input id="f_orange_name" placeholder="TEAM ORANGE"/>
        </div>

        <div>
          <label>Logo Bleu (URL)</label>
          <input id="f_blue_logo" placeholder="https://.../blue.png"/>
        </div>
        <div>
          <label>Logo Orange (URL)</label>
          <input id="f_orange_logo" placeholder="https://.../orange.png"/>
        </div>

        <div>
          <label>Couleur Bleue</label>
          <input id="f_blue_color" type="color" value="#5DADE2"/>
        </div>
        <div>
          <label>Couleur Orange</label>
          <input id="f_orange_color" type="color" value="#F39C12"/>
        </div>

        <div>
          <label>Wins Bleu</label>
          <input id="f_blue_wins" type="number" min="0" value="0"/>
        </div>
        <div>
          <label>Wins Orange</label>
          <input id="f_orange_wins" type="number" min="0" value="0"/>
        </div>

        <div>
          <label>WebSocket URL (SOS)</label>
          <input id="f_ws_url" placeholder="ws://localhost:49122" value="ws://localhost:49122"/>
          <div class="tiny">M√™me PC : <b>ws://localhost:49122</b></div>
        </div>

        <div>
          <label>HUD / Frame (URL PNG export Photoshop)</label>
          <input id="f_hud_frame" placeholder="https://.../hud.png"/>
          <div class="row" style="margin-top:10px">
            <button class="secondary" id="btnLayout" type="button">üß© √âditer le placement</button>
            <button class="secondary" id="btnPreview" type="button">üëÅÔ∏è Preview (d√©mo)</button>
          </div>
        </div>

        <div>
          <label>Sponsor (texte)</label>
          <input id="f_sponsor_text" placeholder="Sponsoris√© par ..."/>
        </div>
        <div>
          <label>Sponsor (logo URL)</label>
          <input id="f_sponsor_logo" placeholder="https://.../sponsor.png"/>
          <div class="tiny">Si texte + logo vides ‚Üí la sponsor bar n'appara√Æt pas.</div>
        </div>

        <div style="grid-column:1 / -1">
          <label><input type="checkbox" id="f_layout_locked"/> Verrouiller le HUD (frame + sponsor + layout)</label>
          <div class="tiny">Quand c'est verrouill√© : tu peux encore changer <b>noms d'√©quipes</b>, <b>logos</b> et <b>wins</b>.</div>
        </div>

        <div style="grid-column:1 / -1">
          <label>Layout JSON (avanc√©)</label>
          <textarea id="f_layout_json" rows="5" placeholder='{"blueName":{"x":545,"y":34,"w":260,"h":74,"fontSize":38}, ...}'></textarea>
          <div class="tiny">Tu peux laisser vide : si une frame est d√©finie, on applique le preset RLCS automatiquement.</div>
        </div>
      </div>

      <div class="actions">
        <button class="danger" id="btnDelete" style="display:none">Supprimer</button>
        <button class="secondary" id="btnCancel">Annuler</button>
        <button id="btnSave">Sauvegarder</button>
      </div>
      <div class="tiny" id="modalMsg" style="margin-top:10px"></div>
    </main>
  </div>
</div>

<!-- Modal: Layout editor -->
<div class="modal" id="layoutModal">
  <div class="box">
    <header>
      <div style="font-weight:900">üß© Placement du HUD</div>
      <button class="secondary" id="btnCloseLayout">‚úï</button>
    </header>
    <main>
      <div class="editorWrap">
        <div class="preview" id="preview">
          <img id="previewImg" alt="Frame preview"/>
          <div class="handle" data-k="blueName"><small>Blue Name</small></div>
          <div class="handle" data-k="blueScore"><small>Blue Score</small></div>
          <div class="handle" data-k="time"><small>Time</small></div>
          <div class="handle" data-k="orangeScore"><small>Orange Score</small></div>
          <div class="handle" data-k="orangeName"><small>Orange Name</small></div>
        </div>

        <div class="card" style="margin:0">
          <div style="font-weight:900;margin-bottom:6px">Preset</div>
          <div class="row" style="margin-bottom:10px">
            <button class="secondary" id="btnPresetRLCS" type="button">Appliquer preset RLCS</button>
            <button class="secondary" id="btnPresetClear" type="button">Effacer layout</button>
          </div>

          <div class="tiny">Astuce : tu peux bouger les zones pour les aligner √† ta frame Photoshop.</div>
          <div style="height:10px"></div>

          <div style="font-weight:900;margin-bottom:6px">Valeurs (px en 1920√ó1080)</div>
          <div id="kvList"></div>

          <div class="actions">
            <button class="secondary" id="btnLayoutCancel" type="button">Fermer</button>
            <button id="btnLayoutApply" type="button">Appliquer au champ Layout JSON</button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://vxwahcquiueympgpciqo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4d2FoY3F1aXVleW1wZ3BjaXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMTQ0MTIsImV4cCI6MjA4NDU5MDQxMn0.ussT6yt_Qcc6Ft0a4wHNR_VFnHspg7EpLiD3SmkWv80';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const BASE_W=1920, BASE_H=1080;
const DEFAULT_LAYOUT_RLCS = {
  blueName: {x:545,y:34,w:260,h:74,fontSize:38},
  blueScore: {x:817,y:34,w:67,h:74,fontSize:50},
  time: {x:886,y:34,w:147,h:74,fontSize:40},
  orangeScore: {x:1034,y:34,w:69,h:74,fontSize:50},
  orangeName: {x:1115,y:34,w:262,h:74,fontSize:38},
};

let session=null;
let events=[];
let editing=null;

const $=id=>document.getElementById(id);

function setAuthUI(isAuthed) {
  $('loginCard').style.display = isAuthed ? 'none':'block';
  $('eventsCard').style.display = isAuthed ? 'block':'none';
  $('authTxt').textContent = isAuthed ? 'Connect√©' : 'Non connect√©';
  $('authPill').classList.toggle('ok', isAuthed);
  $('authPill').classList.toggle('bad', !isAuthed);
}

function safeJSON(str) {
  if(!str || !str.trim()) return null;
  try { return JSON.parse(str); } catch { return null; }
}

async function login() {
  $('loginMsg').textContent = '';
  const email = $('email').value.trim();
  const password = $('password').value;
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error) {
    $('loginMsg').textContent = 'Erreur: ' + error.message;
    return;
  }
  session = data.session;
  setAuthUI(true);
  await loadEvents();
}

async function logout() {
  await sb.auth.signOut();
  session=null;
  setAuthUI(false);
}

async function loadEvents() {
  const { data, error } = await sb.from('event_configs').select('*').order('created_at', {ascending:false});
  if(error) {
    console.error(error);
    return;
  }
  events = data || [];
  renderEvents();
}

function renderEvents() {
  const baseUrl = location.href.replace(/admin\.html.*$/,'').replace(/\?.*$/,'');
  const rows = events.map(e=>{
    const overlayUrl = baseUrl + 'overlay.html?event=' + encodeURIComponent(e.event_id);
    const demoUrl = overlayUrl + '&demo=1';
    return `
      <tr>
        <td style="width:34%"><div style="font-weight:900">${escapeHTML(e.event_name||'Sans titre')}</div>
          <div class="tiny muted">event_id: <b>${escapeHTML(e.event_id)}</b></div>
        </td>
        <td style="width:42%">
          <div class="tiny">URL OBS:</div>
          <div style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;font-size:12px;word-break:break-all;opacity:.95">${escapeHTML(overlayUrl)}</div>
          <div class="tiny" style="margin-top:6px">Preview: <a href="${demoUrl}" target="_blank" rel="noopener">ouvrir en d√©mo</a></div>
        </td>
        <td style="width:24%;text-align:right">
          <button class="secondary" onclick="openEdit('${e.event_id}')">Modifier</button>
        </td>
      </tr>
    `;
  }).join('');
  $('eventsTable').innerHTML = rows ? rows : '<tr><td>Pas encore d\'√©v√©nements.</td></tr>';
}

function escapeHTML(s) {
  return (s??'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function openModal(isOpen) {
  $('eventModal').style.display = isOpen ? 'flex' : 'none';
}

function openNew() {
  editing = null;
  $('modalTitle').textContent='Nouvel √©v√©nement';
  $('btnDelete').style.display='none';
  fillForm({
    event_name:'',blue_team_name:'TEAM BLUE',orange_team_name:'TEAM ORANGE',
    blue_color:'#5DADE2',orange_color:'#F39C12',best_of:5,blue_wins:0,orange_wins:0,
    ws_url:'ws://localhost:49122', blue_logo_url:'', orange_logo_url:'',
    hud_frame_url:'', sponsor_text:'', sponsor_logo_url:'',
    layout_locked:false, layout_json:''
  });
  openModal(true);
}

function openEdit(id) {
  const e = events.find(x=>x.event_id===id);
  if(!e) return;
  editing = e;
  $('modalTitle').textContent='Modifier √©v√©nement';
  $('btnDelete').style.display='inline-block';
  fillForm(e);
  openModal(true);
}
window.openEdit=openEdit;

function fillForm(e) {
  $('f_event_name').value = e.event_name ?? '';
  $('f_blue_name').value = e.blue_team_name ?? '';
  $('f_orange_name').value = e.orange_team_name ?? '';
  $('f_blue_logo').value = e.blue_logo_url ?? '';
  $('f_orange_logo').value = e.orange_logo_url ?? '';
  $('f_blue_color').value = e.blue_color ?? '#5DADE2';
  $('f_orange_color').value = e.orange_color ?? '#F39C12';
  $('f_best_of').value = e.best_of ?? 5;
  $('f_blue_wins').value = e.blue_wins ?? 0;
  $('f_orange_wins').value = e.orange_wins ?? 0;
  $('f_ws_url').value = e.ws_url ?? 'ws://localhost:49122';
  $('f_hud_frame').value = e.hud_frame_url ?? '';
  $('f_sponsor_text').value = e.sponsor_text ?? '';
  $('f_sponsor_logo').value = e.sponsor_logo_url ?? '';
  $('f_layout_locked').checked = !!e.layout_locked;
  // layout_json can be object (jsonb) or string
  const lj = (typeof e.layout_json === 'object' && e.layout_json) ? JSON.stringify(e.layout_json, null, 2) : (e.layout_json ?? '');
  $('f_layout_json').value = lj;
  updateLockUI();
}

function updateLockUI() {
  const locked = $('f_layout_locked').checked;
  $('f_hud_frame').disabled = locked;
  $('f_sponsor_text').disabled = locked;
  $('f_sponsor_logo').disabled = locked;
  $('f_layout_json').disabled = locked;
  $('btnLayout').disabled = locked;
}

async function saveEvent() {
  $('modalMsg').textContent='';
  const payload = {
    event_name: $('f_event_name').value.trim() || 'Sans titre',
    blue_team_name: $('f_blue_name').value.trim() || 'TEAM BLUE',
    orange_team_name: $('f_orange_name').value.trim() || 'TEAM ORANGE',
    blue_logo_url: $('f_blue_logo').value.trim() || null,
    orange_logo_url: $('f_orange_logo').value.trim() || null,
    blue_color: $('f_blue_color').value,
    orange_color: $('f_orange_color').value,
    best_of: parseInt($('f_best_of').value||'5',10),
    blue_wins: parseInt($('f_blue_wins').value||'0',10),
    orange_wins: parseInt($('f_orange_wins').value||'0',10),
    ws_url: $('f_ws_url').value.trim() || 'ws://localhost:49122',
    hud_frame_url: $('f_hud_frame').value.trim() || null,
    sponsor_text: $('f_sponsor_text').value.trim() || null,
    sponsor_logo_url: $('f_sponsor_logo').value.trim() || null,
    layout_locked: $('f_layout_locked').checked,
  };

  const layoutStr = $('f_layout_json').value.trim();
  const layoutObj = layoutStr ? safeJSON(layoutStr) : null;
  if(layoutStr && !layoutObj) {
    $('modalMsg').textContent = 'Erreur: Layout JSON invalide';
    return;
  }
  payload.layout_json = layoutObj;

  let res;
  if(editing) {
    // Respect lock: if locked, keep frame/sponsor/layout from DB but allow teams/logos/wins
    if(editing.layout_locked) {
      payload.hud_frame_url = editing.hud_frame_url ?? null;
      payload.sponsor_text = editing.sponsor_text ?? null;
      payload.sponsor_logo_url = editing.sponsor_logo_url ?? null;
      payload.layout_json = editing.layout_json ?? null;
      payload.layout_locked = true;
    }
    res = await sb.from('event_configs').update(payload).eq('event_id', editing.event_id);
  } else {
    payload.event_id = crypto.randomUUID();
    // required by RLS policy
    if(session?.user?.id) payload.created_by = session.user.id;
    res = await sb.from('event_configs').insert(payload);
  }

  if(res.error) {
    $('modalMsg').textContent = 'Erreur: ' + res.error.message;
    return;
  }
  openModal(false);
  await loadEvents();
}

async function deleteEvent() {
  if(!editing) return;
  const res = await sb.from('event_configs').delete().eq('event_id', editing.event_id);
  if(res.error) {
    $('modalMsg').textContent='Erreur: '+res.error.message;
    return;
  }
  openModal(false);
  await loadEvents();
}

function openPreview() {
  const baseUrl = location.href.replace(/admin\.html.*$/,'').replace(/\?.*$/,'');
  const ev = editing ? editing.event_id : 'PREVIEW';
  const url = baseUrl + 'overlay.html?event=' + encodeURIComponent(ev) + '&demo=1';
  window.open(url, '_blank', 'noopener');
}

// ===== Layout editor =====
let layoutDraft = JSON.parse(JSON.stringify(DEFAULT_LAYOUT_RLCS));
let drag = null;

function openLayoutEditor() {
  const frame = $('f_hud_frame').value.trim();
  $('previewImg').src = frame || '';
  // init draft from field if present, else RLCS preset
  const existing = safeJSON($('f_layout_json').value);
  layoutDraft = existing ? existing : JSON.parse(JSON.stringify(DEFAULT_LAYOUT_RLCS));
  renderLayoutHandles();
  renderKV();
  $('layoutModal').style.display='flex';
}

function closeLayoutEditor() {
  $('layoutModal').style.display='none';
}

function renderLayoutHandles() {
  const preview = $('preview');
  const rect = preview.getBoundingClientRect();
  const sx = rect.width / BASE_W;
  const sy = rect.height / BASE_H;

  document.querySelectorAll('.handle').forEach(h=>{
    const k = h.dataset.k;
    const c = layoutDraft[k];
    if(!c) return;
    h.style.left = (c.x*sx)+'px';
    h.style.top = (c.y*sy)+'px';
    h.style.width = (c.w*sx)+'px';
    h.style.height = (c.h*sy)+'px';
  });
}

function renderKV() {
  const keys = ['blueName','blueScore','time','orangeScore','orangeName'];
  const wrap = $('kvList');
  wrap.innerHTML = keys.map(k=>{
    const c=layoutDraft[k];
    return `
      <div style="font-weight:900;margin-top:10px">${k}</div>
      <div class="kv"><div class="tiny">x</div><input data-k="${k}" data-f="x" type="number" value="${c.x}"></div>
      <div class="kv"><div class="tiny">y</div><input data-k="${k}" data-f="y" type="number" value="${c.y}"></div>
      <div class="kv"><div class="tiny">w</div><input data-k="${k}" data-f="w" type="number" value="${c.w}"></div>
      <div class="kv"><div class="tiny">h</div><input data-k="${k}" data-f="h" type="number" value="${c.h}"></div>
      <div class="kv"><div class="tiny">font</div><input data-k="${k}" data-f="fontSize" type="number" value="${c.fontSize||0}"></div>
    `;
  }).join('');
  wrap.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', () => {
      const k = inp.dataset.k;
      const f = inp.dataset.f;
      layoutDraft[k][f] = parseInt(inp.value||'0',10);
      renderLayoutHandles();
    });
  });
}

function applyLayoutToField() {
  $('f_layout_json').value = JSON.stringify(layoutDraft, null, 2);
  closeLayoutEditor();
}

function setPresetRLCS() {
  layoutDraft = JSON.parse(JSON.stringify(DEFAULT_LAYOUT_RLCS));
  renderLayoutHandles();
  renderKV();
}
function clearLayout() {
  layoutDraft = {};
  $('f_layout_json').value = '';
  renderLayoutHandles();
  renderKV();
}

function onPointerDown(e) {
  const h = e.target.closest('.handle');
  if(!h) return;
  const k = h.dataset.k;
  const preview = $('preview').getBoundingClientRect();
  const sx = preview.width / BASE_W;
  const sy = preview.height / BASE_H;
  drag = {
    k,
    startX: e.clientX,
    startY: e.clientY,
    orig: {...layoutDraft[k]},
    sx, sy
  };
  h.setPointerCapture(e.pointerId);
}

function onPointerMove(e) {
  if(!drag) return;
  const dx = (e.clientX - drag.startX) / drag.sx;
  const dy = (e.clientY - drag.startY) / drag.sy;
  layoutDraft[drag.k].x = Math.round(drag.orig.x + dx);
  layoutDraft[drag.k].y = Math.round(drag.orig.y + dy);
  renderLayoutHandles();
  // update kv inputs if visible
  const inpX = document.querySelector(`input[data-k="${drag.k}"][data-f="x"]`);
  const inpY = document.querySelector(`input[data-k="${drag.k}"][data-f="y"]`);
  if(inpX) inpX.value = layoutDraft[drag.k].x;
  if(inpY) inpY.value = layoutDraft[drag.k].y;
}

function onPointerUp(e) {
  drag = null;
}

function bind() {
  $('btnLogin').onclick = login;
  $('btnLogout').onclick = logout;
  $('btnNew').onclick = openNew;
  $('btnCloseModal').onclick = ()=>openModal(false);
  $('btnCancel').onclick = ()=>openModal(false);
  $('btnSave').onclick = saveEvent;
  $('btnDelete').onclick = deleteEvent;
  $('f_layout_locked').onchange = updateLockUI;
  $('btnPreview').onclick = openPreview;
  $('btnLayout').onclick = openLayoutEditor;

  $('btnCloseLayout').onclick = closeLayoutEditor;
  $('btnLayoutCancel').onclick = closeLayoutEditor;
  $('btnLayoutApply').onclick = applyLayoutToField;
  $('btnPresetRLCS').onclick = setPresetRLCS;
  $('btnPresetClear').onclick = clearLayout;

  $('preview').addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerUp);
  window.addEventListener('resize', () => {
    if($('layoutModal').style.display==='flex') renderLayoutHandles();
  });
}

async function init() {
  bind();
  const { data } = await sb.auth.getSession();
  session = data.session;
  setAuthUI(!!session);
  if(session) await loadEvents();
}

init();
</script>
</body>
</html>
