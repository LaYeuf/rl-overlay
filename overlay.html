<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RL Overlay</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  html,body{width:100%;height:100%;margin:0;background:transparent;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  :root{ --w:1920; --h:1080; }
  #overlay{position:relative;width:100%;height:100%}
  #hudFrame{position:absolute;inset:0;width:100%;height:100%;object-fit:fill;pointer-events:none;z-index:1;display:none}
  #layer{position:absolute;inset:0;z-index:2;pointer-events:none}
  .box{position:absolute;display:flex;align-items:center;justify-content:center;}
  .nameBox{justify-content:flex-start;gap:14px;padding:0 18px}
  .teamLogo{height:70%;width:auto;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.45));display:none}
  .teamName{font-weight:800;letter-spacing:.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .score{font-weight:900}
  .time{font-weight:900;letter-spacing:1px}
  .shadow{text-shadow:0 6px 18px rgba(0,0,0,.65)}
  /* Fallback (no frame/layout): simple top bar */
  #fallbackBar{position:absolute;top:30px;left:50%;transform:translateX(-50%);display:none;align-items:center;gap:18px;
    background:rgba(10,10,15,.85);backdrop-filter:blur(15px);padding:14px 22px;border-radius:12px;border:1px solid rgba(255,255,255,.1);z-index:3;pointer-events:none}
  #fallbackBar .sec{display:flex;align-items:center;gap:10px;min-width:220px}
  #fallbackBar img{width:34px;height:34px;object-fit:contain;display:none}
  #fallbackBar .nm{font-weight:800}
  #fallbackBar .sc{font-weight:900;font-size:44px}
  #fallbackBar .tm{font-weight:900;font-size:34px;min-width:140px;text-align:center}
  /* Sponsor bar */
  #sponsorBar{position:absolute;left:50%;bottom:46px;transform:translateX(-50%);display:none;align-items:center;gap:14px;
    background:rgba(10,10,15,.70);backdrop-filter:blur(12px);padding:10px 18px;border-radius:999px;border:1px solid rgba(255,255,255,.10);z-index:3}
  #sponsorLogo{height:28px;width:auto;object-fit:contain;display:none}
  #sponsorText{font-weight:700;opacity:.95}
  /* Status */
  #status{position:absolute;left:18px;bottom:18px;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
    color:#fff;padding:10px 12px;border-radius:10px;font-size:12px;z-index:4;display:flex;gap:10px;align-items:center}
  .dot{width:8px;height:8px;border-radius:999px;background:#f55}
  .dot.ok{background:#5f5}
  #demoBadge{position:absolute;right:18px;bottom:18px;background:rgba(0,0,0,.65);color:#fff;padding:10px 12px;border-radius:10px;font-size:12px;z-index:4;display:none}
</style>
</head>
<body>
<div id="overlay">
  <img id="hudFrame" alt="HUD Frame"/>
  <div id="layer">
    <!-- Frame/layout mode -->
    <div id="blueNameBox" class="box nameBox shadow">
      <img id="blueLogo" class="teamLogo" alt="Blue logo"/>
      <div id="blueTeamName" class="teamName"></div>
    </div>
    <div id="blueScoreBox" class="box shadow"><div id="blueScore" class="score"></div></div>

    <div id="timeBox" class="box shadow"><div id="gameTime" class="time"></div></div>

    <div id="orangeScoreBox" class="box shadow"><div id="orangeScore" class="score"></div></div>
    <div id="orangeNameBox" class="box nameBox shadow" style="justify-content:flex-end;">
      <div id="orangeTeamName" class="teamName" style="text-align:right;"></div>
      <img id="orangeLogo" class="teamLogo" alt="Orange logo"/>
    </div>
  </div>

  <!-- Fallback bar -->
  <div id="fallbackBar">
    <div class="sec">
      <img id="fbBlueLogo" alt="Blue logo"/>
      <div class="nm" id="fbBlueName">TEAM BLUE</div>
    </div>
    <div class="sc" id="fbBlueScore">0</div>
    <div class="tm" id="fbTime">05:00</div>
    <div class="sc" id="fbOrangeScore">0</div>
    <div class="sec" style="justify-content:flex-end;">
      <div class="nm" id="fbOrangeName">TEAM ORANGE</div>
      <img id="fbOrangeLogo" alt="Orange logo"/>
    </div>
  </div>

  <div id="sponsorBar">
    <img id="sponsorLogo" alt="Sponsor logo"/>
    <div id="sponsorText"></div>
  </div>

  <div id="status"><span id="statusDot" class="dot"></span><span id="statusText">Chargement…</span></div>
  <div id="demoBadge">MODE DÉMO</div>
</div>

<script>
const SUPABASE_URL = 'https://vxwahcquiueympgpciqo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4d2FoY3F1aXVleW1wZ3BjaXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMTQ0MTIsImV4cCI6MjA4NDU5MDQxMn0.ussT6yt_Qcc6Ft0a4wHNR_VFnHspg7EpLiD3SmkWv80';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const qs = new URLSearchParams(location.search);
const eventId = qs.get('event');
const demo = qs.get('demo') === '1';

const BASE_W = 1920, BASE_H = 1080;

// RLCS preset (d'après ton frame)
const DEFAULT_LAYOUT_RLCS = {
  blueName: {x:545,y:34,w:260,h:74, fontSize:38},
  blueScore: {x:817,y:34,w:67,h:74, fontSize:50},
  time:     {x:886,y:34,w:147,h:74, fontSize:40},
  orangeScore: {x:1034,y:34,w:69,h:74, fontSize:50},
  orangeName:  {x:1115,y:34,w:262,h:74, fontSize:38},
};

function pctX(px){ return (px/BASE_W*100).toFixed(6)+'%'; }
function pctY(px){ return (px/BASE_H*100).toFixed(6)+'%'; }

function applyBox(el, conf, fontTargetId=null) {
  if(!conf) return;
  el.style.left = pctX(conf.x);
  el.style.top = pctY(conf.y);
  el.style.width = pctX(conf.w);
  el.style.height = pctY(conf.h);
  if(fontTargetId && conf.fontSize) {
    const tgt = document.getElementById(fontTargetId);
    tgt.style.fontSize = (conf.fontSize/BASE_W*100).toFixed(4)+'vw'; // scale with width
  }
}

function showFrameMode(layout) {
  document.getElementById('fallbackBar').style.display = 'none';
  document.getElementById('hudFrame').style.display = 'block';

  const L = layout || DEFAULT_LAYOUT_RLCS;

  applyBox(document.getElementById('blueNameBox'), L.blueName, 'blueTeamName');
  applyBox(document.getElementById('blueScoreBox'), L.blueScore, 'blueScore');
  applyBox(document.getElementById('timeBox'), L.time, 'gameTime');
  applyBox(document.getElementById('orangeScoreBox'), L.orangeScore, 'orangeScore');
  applyBox(document.getElementById('orangeNameBox'), L.orangeName, 'orangeTeamName');
}

function showFallbackMode() {
  document.getElementById('hudFrame').style.display = 'none';
  document.getElementById('fallbackBar').style.display = 'flex';
}

function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt ?? ''; }
function setImg(id, url) {
  const el=document.getElementById(id);
  if(!el) return;
  if(url){ el.src=url; el.style.display='block'; }
  else { el.removeAttribute('src'); el.style.display='none'; }
}

function setStatus(ok, text) {
  const dot = document.getElementById('statusDot');
  dot.classList.toggle('ok', !!ok);
  document.getElementById('statusText').textContent = text;
}

function applyConfig(cfg) {
  const blueName = cfg.blue_team_name || 'TEAM BLUE';
  const orangeName = cfg.orange_team_name || 'TEAM ORANGE';
  const wsUrl = cfg.ws_url || 'ws://localhost:49122';

  // Frame + layout
  const frameUrl = cfg.hud_frame_url || '';
  let layout = cfg.layout_json || null;

  // layout_json peut arriver en string selon la config
  if(typeof layout === 'string') {
    try { layout = JSON.parse(layout); } catch(e) { layout = null; }
  }

  if(frameUrl) {
    document.getElementById('hudFrame').src = frameUrl;
    // si pas de layout, on applique le preset RLCS par défaut
    showFrameMode(layout || DEFAULT_LAYOUT_RLCS);
  } else {
    showFallbackMode();
  }

  // Names/scores
  setText('blueTeamName', blueName);
  setText('orangeTeamName', orangeName);
  setText('fbBlueName', blueName);
  setText('fbOrangeName', orangeName);

  setImg('blueLogo', cfg.blue_logo_url);
  setImg('orangeLogo', cfg.orange_logo_url);
  setImg('fbBlueLogo', cfg.blue_logo_url);
  setImg('fbOrangeLogo', cfg.orange_logo_url);

  // Sponsor bar (si vide => caché)
  const sTxt = (cfg.sponsor_text || '').trim();
  const sLogo = (cfg.sponsor_logo_url || '').trim();
  const sbEl = document.getElementById('sponsorBar');
  if(sTxt || sLogo) {
    sbEl.style.display='flex';
    setText('sponsorText', sTxt);
    setImg('sponsorLogo', sLogo);
    if(!sTxt) document.getElementById('sponsorText').textContent = '';
  } else {
    sbEl.style.display='none';
  }

  // Store ws url for later (SOS)
  window.__WS_URL = wsUrl;

  setStatus(true, 'Config chargée');
}

function parseLayoutMaybe(val) {
  if(!val) return null;
  if(typeof val === 'object') return val; // already json
  try { return JSON.parse(val); } catch { return null; }
}

async function loadConfig() {
  if(!eventId) {
    setStatus(false, 'Paramètre ?event= manquant');
    return;
  }
  const { data, error } = await sb.from('event_configs').select('*').eq('event_id', eventId).limit(1).maybeSingle();
  if(error || !data) {
    setStatus(false, 'Event introuvable / accès refusé');
    return;
  }
  // normalize layout_json
  data.layout_json = parseLayoutMaybe(data.layout_json);
  applyConfig(data);
  startConfigSync(eventId);
}

let realtimeChan=null;
function startConfigSync(ev) {
  // Realtime si dispo, sinon polling
  try {
    realtimeChan = sb.channel('cfg-'+ev).on('postgres_changes', {
      event:'UPDATE', schema:'public', table:'event_configs', filter:'event_id=eq.'+ev
    }, payload => {
      const row = payload.new;
      row.layout_json = parseLayoutMaybe(row.layout_json);
      applyConfig(row);
    }).subscribe();
  } catch(e) {
    // ignore
  }

  setInterval(async ()=>{
    const { data } = await sb.from('event_configs').select('*').eq('event_id', ev).limit(1).maybeSingle();
    if(data) {
      data.layout_json = parseLayoutMaybe(data.layout_json);
      applyConfig(data);
    }
  }, 3000);
}

// DEMO (sans SOS)
function startDemo() {
  document.getElementById('demoBadge').style.display='block';
  let t = 5*60;
  let b=0,o=0;
  function fmt(n){ const m=Math.floor(n/60).toString().padStart(2,'0'); const s=(n%60).toString().padStart(2,'0'); return m+':'+s; }
  setInterval(()=>{
    t = Math.max(0, t-1);
    const timeStr = fmt(t);
    setText('gameTime', timeStr);
    setText('fbTime', timeStr);
    // random goal occasionally
    if(Math.random()<0.02) b++;
    if(Math.random()<0.02) o++;
    setText('blueScore', b);
    setText('orangeScore', o);
    setText('fbBlueScore', b);
    setText('fbOrangeScore', o);
  }, 1000);
}

if(demo) startDemo();
loadConfig();
</script>
</body>
</html>
